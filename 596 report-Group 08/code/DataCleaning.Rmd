---
title: "Data Cleaning"
author: "Kanishk Deshwal"
date: "`r Sys.Date()`"
output: html_document
---

```{r }

data <- read.csv("../data/indian companies complete data 2025.csv",
                 stringsAsFactors = FALSE)
data <- data[!duplicated(data$COMPANY.NAME), ]

head(data)
summary(data)
```
**
Company Type
**

Get all unique values of Company Type and their counts.

```{r}

vars = unique(data$COMPANY.TYPE)
val = c()
for (i in vars) val = append(val, sum(data$COMPANY.TYPE==i))
distinct = data.frame("Company Type" = vars, "Count" =val)
distinct = distinct[order(-distinct$Count), ]
distinct[0:20, ]
```
  
Only 9 types of companies exist, rest all of them are false/NaN values.    
Total number of companies having actual data in the field (Company Type):

```{r}
sum(head(distinct[!(distinct$Company.Type %in% c("", " ", "nan")), ], 9)$Count)
```
Clearly, Company Type is not a suitable parameter.

**
Year Old
**

Now, lets jump to Year Old parameter for data cleaning: Extracting Years from string of chars and applying transformation.

```{r}
extract_years <- function(x) {
  x <- x["YEAR.OLD"]
  if (grepl("years old", x)) {
    as.numeric(gsub("[^0-9]", "", x))
  }
  else{
    NA
  }
}


data["YEARS.OLD.CLEANED"] = apply(data, 1, extract_years)

```

Handling extreme values for Years Old:
```{r}
data[(!is.na(data$YEARS.OLD.CLEANED) & data$YEARS.OLD.CLEANED>200), 13] = NA
summary(data$YEARS.OLD.CLEANED)
```

**
Industry
**
  
Removing unwanted values from Industry, i.e. locations from Industry colum
```{r}
unique(data$INDUSTRY)[0:30]

extract_industry <- function(x){
  x = x["INDUSTRY"]
  if (grepl("locations", x)) NA
  else x
}

data$INDUSTRY.CLEANED = apply(data, 1, extract_industry)

```
  
Calculating unique values and counts in a similar way.

```{r}

vars = unique(data$INDUSTRY.CLEANED)
val = c()
for (i in vars) val = append(val, sum(data$INDUSTRY.CLEANED==i, na.rm = TRUE))
distinct = data.frame("INDUSTRY" = vars, "Count" =val)
distinct = distinct[order(-distinct$Count), ]
distinct[0:20, ]

```
The approach here is to minimize dummy variables so that each variable holds significant amount of data. Selecting n (number of dummy variables) where n covers atleast 50% of the data.

```{r}
library(forcats)

total <- sum(distinct[, 2])
part <- 0
i <- 0
for(count in distinct[ ,2]){
  part <- part+count
  if(part>(total*0.50)){
    break
  }
  i <- i+1
}

data$INDUSTRY.LUMPED <- fct_lump(data$INDUSTRY.CLEANED, n = i)
summary(data$INDUSTRY.LUMPED)
```

**
INDIA HQ (Headquarter)
**

Calculating unique values and their counts for India Headquarters of Companies.

```{r}

vars = unique(data$INDIA.HQ)
val = c()
for (i in vars) val = append(val, sum(data$INDIA.HQ==i))
distinct = data.frame("INDUSTRY" = unique(data$INDIA.HQ), "Count" =val)
distinct = distinct[order(-distinct$Count), ]
distinct[0:20, ]

```

For India headquarters, lets take top 5 locations around the country and the rest to others.

```{r}

data$INDIA.HQ.LUMPED <- fct_lump(data$INDIA.HQ, n = 5)
summary(data$INDIA.HQ.LUMPED)

```

Clearly, taking top 5 cities represents around 60% of the variable while rest cities are represented by others.

**
Conclusion: 
**

1. Out of the 3 categorical variables, Company Type should be dropped as nearly 80% of the data is either false or NA. 
Industry and India HQ are lumped to represent majority of the data keeping model cleaner, simple and avoiding over-fitting.
2. Year Old is transformed to hold numeric values while extreme and unnecessary values are set to NA.

***
Total Employees  
***

```{r warning=FALSE}

library(tidyverse)

convert_suffix <- function(x) {
  x <- str_trim(x)
  case_when(
    is.na(x) | x == "" ~ NA_real_,
    str_detect(x, "l$") ~ as.numeric(str_remove(x, "l")) * 100000,
    str_detect(x, "k$") ~ as.numeric(str_remove(x, "k")) * 1000,
    TRUE ~ suppressWarnings(as.numeric(x))
  )
}

clean_total_employees <- function(vec) {
  
  tibble(raw = as.character(vec)) %>%
    mutate(
      x = str_to_lower(str_trim(raw)),
      
      # Filtering invalid rows
      x = case_when(
        x == "" | x == "na" ~ NA_character_,
        str_detect(x, "years? old") ~ NA_character_,
        str_detect(x, "\\d{2}[-/]\\d{2}[-/]\\d{4}") ~ NA_character_, # Catches 01-10-2025
        str_detect(x, "employees") ~ NA_character_,
        str_detect(x, "[a-z]") & !str_detect(x, "(k|l|lakh|global)") ~ NA_character_,
        TRUE ~ x
      ),
      
      x = str_remove_all(x, "\\(?global\\)?"), # Global
      x = str_remove_all(x, " "),              # Removing spaces
      x = str_remove_all(x, "\\+"),            # Removing + signs
      x = str_replace_all(x, "lakh", "l")      # Normalize lakh -> l
    ) %>%
    
    separate(x, into = c("low", "high"), sep = "-", fill = "right") %>%
    
    mutate(
      low_num  = convert_suffix(low),
      high_num = convert_suffix(high),
      
      final = case_when(
        !is.na(high_num) ~ (low_num + high_num) / 2,
        
        low == "1l" ~ 150000,
        
        TRUE ~ low_num
      )
    ) %>%
    select(raw, final)
}

emp_clean <- clean_total_employees(data$TOTAL.EMPLOYEES)
emp_clean$final_log <- log(emp_clean$final)

data$TOTAL_EMPLOYEES_CLEAN <- emp_clean$final_log

summary(emp_clean$final_log)

```

***
Number of Branches  
***
```{r}

data$BRANCHES_NUM = as.integer(gsub("[^0-9]", "", data$BRANCHES))
summary(data$BRANCHES_NUM)

```

**
Rating  
**

```{r}

data$RATING.CLEANED <- suppressWarnings(as.numeric(data$RATING))
summary(data$RATING.CLEANED)
                              
```

**
Reviews  
**

```{r}

clean_reviews <- function(x) {
  x <- gsub("[()]", "", x)
  
  if (grepl("L", x, ignore.case = TRUE)) {
    num <- as.numeric(gsub("[^0-9.]", "", x))
    return(num * 100000)
  }
  
  if (grepl("k", x, ignore.case = TRUE)) {
    num <- as.numeric(gsub("[^0-9.]", "", x))
    return(num * 1000)
  }
  
  num <- suppressWarnings(as.numeric(gsub("[^0-9]", "", x)))
  return(num)
}

data$REVIEWS.CLEANED <- sapply(data$REVIEWS, clean_reviews)
summary(data$REVIEWS_CLEANED)

```

**
Package  
**

```{r warning=FALSE}

package_scaled <- function(x) {
  if (grepl("L", x, ignore.case = TRUE)) {
    num <- as.numeric(gsub("[^0-9.]", "", x))
    return(num)
  }
  if (grepl("k", x, ignore.case = TRUE)) {
    num <- as.numeric(gsub("[^0-9.]", "", x))
    return(num/100)
  }
  return(as.numeric(x) / 100000)
}

data$PACKAGE.SCALED <- sapply(data$PACKAGE, package_scaled)
summary(data$PACKAGE.SCALED)

```

Export Cleaned and Transformed Dataset:

```{r}

df <- data[c("YEARS.OLD.CLEANED","INDUSTRY.LUMPED","INDIA.HQ.LUMPED","TOTAL_EMPLOYEES_CLEAN","BRANCHES_NUM","RATING.CLEANED","REVIEWS.CLEANED","PACKAGE.SCALED")]

colnames(df) = c("YEARS.OLD","INDUSTRY","INDIA.HQ","TOTAL_EMPLOYEES","BRANCHES","RATING","REVIEWS","PACKAGE")
rownames(df) = data[, 1]

write.csv(df, "indian_companies_processed.csv", row.names = TRUE)

summary(df)

```
```{r}

lmod = lm(PACKAGE ~ ., df)
summary(lmod)

```


