---
title: "Diagnostics"
output: html_document
date: "2025-12-05"
---

Loading the data:

```{r, echo=FALSE}
data = read.csv("../data/indian_companies_processed.csv", skipNul = TRUE, row.names=1)
head(data)
```

Fitting Linear model

```{r, echo=FALSE}
lmod = lm(PACKAGE ~ ., data = data)
summary(lmod)
n = nrow(data)
p = length(coef(lmod))
```

# Residuals vs Fitted Values

```{r, echo=FALSE}
plot(lmod, 1)
```

The residuals vs fitted plot indicates clear heteroscedasticity, as the spread of residuals increases for larger fitted PACKAGE values. The pattern is not centered tightly around zero, and a downward trend is visible, suggesting model misspecification or missing nonlinear terms. A few companies (e.g., Infosys, Teleperformance, iEnergizer) display extreme deviations, indicating potential outliers and influential observations

# Box-Cox

```{r, echo=FALSE}
library(MASS)

bc = boxcox(lmod, lambda = seq(-2, 2, 0.1))
bc
```

```{r, echo=FALSE}
lambda_opt = bc$x[which.max(bc$y)]
lambda_opt
```

Since λ is close to zero, we apply log transformations.

```{r, echo=FALSE}
data$PACKAGE = log(data$PACKAGE)
lmod_log = lm(PACKAGE ~ ., data = data)
summary(lmod_log)
```

```{r, echo=FALSE}
plot(lmod_log, 1)
```

The Box–Cox (log) transformation of the response reduced heteroscedasticity, but it was not completely eliminated. 

To further diagnose the issue, we examine the linearity assumption between the response and predictors. Partial residual plots can be used for Rating, Branches, and Reviews to assess nonlinear relationships.

```{r, echo=FALSE}
library(car)
crPlots(lm(PACKAGE ~ BRANCHES + RATING + REVIEWS, data))

```

Based on these plots, additional predictor transformations were considered where nonlinearity was evident, i.e. in case of Branches and Reviews. 

While Rating is almost linear, where quadratic transformation might provide a better fit.

```{r, echo=FALSE}
data$REVIEWS = log(data$REVIEWS)
data$BRANCHES = log(data$BRANCHES)

lmod_trans = lm(PACKAGE ~ YEARS.OLD + INDUSTRY + INDIA.HQ + TOTAL_EMPLOYEES + BRANCHES + I(RATING^2) + REVIEWS , data)
summary(lmod_trans)
plot(lmod_trans, 1)
```

# Q-Q Plot:

```{r, echo=FALSE}
resi = residuals(lmod_trans)
qqnorm(resi)
qqline(resi)
```

The Q-Q plot shows departure from normality, with heavy left tail and mild right tail. For large samples, it might not be so critical (CLT applies). But this can be improved upon handling outliers.

Several observations (e.g., TCS, Teleperformance, iEnergizer, HDFC Bank) appear as outlying or high-leverage points in multiple plots, reinforcing influence concerns.

# Leverage Points:

```{r, echo=FALSE}
hval = hatvalues(lmod)
cat("Number of leverage points (>2p/n): ", length(which(hval > 2 * p/n)), "\n")
cat("Companies with highest leverage: ", sort(names(which(hval > 2 * p/n))[0:10]))

```

A large number of observations exceed the leverage threshold 2p/n, indicating many high-leverage companies in the dataset. Most high-leverage cases belong to very large firms. Their combination of extreme workforce/branch presence makes them disproportionately influential in estimating regression coefficients.

# Jackknife Residuals:

```{r, echo=FALSE}
jackres = rstudent(lmod)
crival <- abs(qt(0.1/2/n, n - 1 - p))
cat("Critical value: ", crival, "\n")

id_jack = which(abs(jackres) > crival)
id_jack
```

Using the jackknife-derived outlier threshold (crival = 4.41), we observe that many large firms have residual magnitudes far greater than the cutoff. This confirms these observations as true statistical outliers under formal studentized residual testing. Their extreme salary positions (either significantly above or below model-implied pay levels) indicate structural salary differences not captured by the current predictors.

# Cook's Distance:

```{r, echo=FALSE}

library("faraway")
cook = cooks.distance(lmod)
halfnorm(cook, 1, labs = rownames(data), ylab = "Cook's distance")

id_cook <- which(cook > 1)
id_cook

```
Removing Outliers that are not influential points.

```{r echo=FALSE}
idx = id_jack[!(id_jack %in% id_cook)]
transformed_data = data[-idx, ]
write.csv(transformed_data, "indian_companies_transformed.csv", row.names = TRUE)


lmod_final = lm(PACKAGE ~ YEARS.OLD + INDUSTRY + INDIA.HQ + TOTAL_EMPLOYEES + BRANCHES + I(RATING^2) + REVIEWS, transformed_data)
resi = residuals(lmod_final)
qqnorm(resi)
qqline(resi)

summary(lmod_final)
```















